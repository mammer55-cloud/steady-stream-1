<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Steady Stream V1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg: #fff5e6; 
            --text: #2e2a24; 
            --accent: #b0a491; 
            --active-brown: #8b4513;
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; overflow: hidden; 
            background: var(--bg); font-family: 'Times New Roman', serif; 
            color: var(--text); transition: background 0.5s ease;
        }

        .container { 
            height: 100vh; 
            overflow-y: scroll; 
            scroll-snap-type: y mandatory; 
            scroll-snap-stop: always; /* Forces it to stop at each snap point */
            -webkit-overflow-scrolling: touch; 
            box-sizing: border-box;
        }
        
        .card { 
            height: 100vh; 
            width: 100%;
            scroll-snap-align: start; 
            scroll-snap-stop: always; /* Extra insurance for mobile browsers */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 2rem; 
            box-sizing: border-box; 
            position: relative; 
            text-align: center;
        }

        .seen-badge {
            position: absolute; top: 20px; right: 20px; font-family: sans-serif;
            font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.2px;
            color: var(--accent); opacity: 0.5; padding: 6px 12px;
            border: 1px solid var(--accent); border-radius: 20px;
        }

        .prompt { 
            font-size: 1.7rem; line-height: 1.5; max-width: 600px; 
            margin-bottom: 2rem; opacity: 0; transition: opacity 0.4s ease-in; 
        }

        .prompt.visible { opacity: 1; }

        .bridge { 
            font-family: sans-serif; font-size: 1.1rem; color: var(--accent); 
            max-width: 500px; opacity: 0; transform: translateY(10px); 
            transition: all 0.8s ease-out; display: none; 
        }

        .bridge.visible { opacity: 1; transform: translateY(0); display: block; }

        .ready-btn { 
            background: none; border: 1px solid var(--accent); color: var(--accent); 
            padding: 12px 24px; cursor: pointer; border-radius: 20px; 
            font-family: sans-serif; font-size: 0.9rem;
        }

        .controls { position: absolute; bottom: 120px; display: flex; gap: 30px; align-items: center; }

        .like-btn, .dislike-btn { 
            font-family: sans-serif; font-size: 0.75rem; text-transform: uppercase; 
            letter-spacing: 1.5px; cursor: pointer; opacity: 0.4;
        }

        .like-btn.active { opacity: 1; color: var(--active-brown); font-weight: bold; }

        .thought-input { 
            border: none; border-bottom: 1px solid var(--accent); background: none; 
            padding: 8px; font-size: 0.85rem; width: 160px; text-align: center; 
            color: var(--text); font-family: 'Times New Roman', serif; outline: none;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background: rgba(255, 245, 230, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--accent); display: flex;
            justify-content: center; align-items: center; gap: 25px; z-index: 1000;
        }

        .nav-btn {
            background: none; border: none; color: var(--text); font-family: sans-serif;
            font-size: 0.7rem; text-transform: uppercase; cursor: pointer;
            padding: 8px 16px; border-radius: 20px; opacity: 0.6;
        }

        .nav-btn.active { opacity: 1; background: var(--accent); color: var(--bg); }

        .gallery-view {
            position: absolute; top: 0; left: 0; right: 0; bottom: 70px;
            background: var(--bg); overflow-y: auto; padding: 40px 20px 20px; display: none;
        }

        .gallery-view.active { display: block; }

        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px; max-width: 900px; margin: 0 auto;
        }

        .thumbnail {
            background: rgba(255, 245, 230, 0.5); border: 1px solid var(--accent);
            border-radius: 12px; padding: 20px; cursor: pointer; min-height: 120px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .thumbnail:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
        }

        .status-msg {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--active-brown); color: white; padding: 12px 24px;
            border-radius: 25px; font-family: sans-serif; font-size: 0.85rem;
            z-index: 3000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }

        .status-msg.visible { opacity: 1; }
    </style>
</head>
<body>
    <div class="status-msg" id="statusMsg"></div>
    <div class="container" id="feed"></div>
    <div class="gallery-view" id="gallery"></div>

    <nav class="bottom-nav">
        <button class="nav-btn active" id="homeBtn" onclick="loadFeed()">Home</button>
        <button class="nav-btn" id="savedBtn" onclick="showSavedHub()">Saved</button>
        <button class="nav-btn" onclick="triggerProxyCook()">Cook</button>
    </nav>

    <script>
        const WORKER_URL = "https://steady-stream-api.mammergaming55.workers.dev";
        const SUPABASE_URL = "https://zkhvderypqeamtpzrsti.supabase.co";
        const SUPABASE_KEY = "sb_publishable_xlP0Bw5f6hbChbnuLdL5_A_vWIDpUdA";

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let activeCardId = null;
        let viewStart = 0;
        let currentView = 'feed';
        let savedPosts = [];

        function showStatus(msg, duration = 3000) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.classList.add('visible');
            if (duration > 0) setTimeout(() => el.classList.remove('visible'), duration);
        }

        async function loadFeed() {
            currentView = 'feed';
            document.getElementById('feed').style.display = 'block';
            document.getElementById('gallery').classList.remove('active');
            
            // Update nav buttons
            document.getElementById('homeBtn').classList.add('active');
            document.getElementById('savedBtn').classList.remove('active');
            
            const { data, error } = await _supabase.from('posts')
                .select('*')
                .eq('disliked', false)
                .order('created_at', { ascending: false });
            
            if (!error) renderFeed(data);
        }

        async function showSavedHub() {
            currentView = 'gallery';
            document.getElementById('feed').style.display = 'none';
            const gallery = document.getElementById('gallery');
            gallery.classList.add('active');
            
            // Update nav buttons
            document.getElementById('homeBtn').classList.remove('active');
            document.getElementById('savedBtn').classList.add('active');
            
            const { data, error } = await _supabase.from('posts')
                .select('*')
                .eq('liked', true)
                .order('created_at', { ascending: false });
                
            if (!error && data.length > 0) {
                savedPosts = data;
                renderGallery(data);
            } else {
                gallery.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--accent);">No saved posts yet.</div>';
            }
        }

        function renderGallery(data) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '<div class="gallery-grid"></div>';
            const grid = gallery.querySelector('.gallery-grid');
            
            data.forEach((item, index) => {
                const thumb = document.createElement('div');
                thumb.className = 'thumbnail';
                thumb.innerHTML = `<div style="font-size:0.8rem;">${item.prompt}</div>`;
                thumb.onclick = () => openSavedFeed(index);
                grid.appendChild(thumb);
            });
        }

        function openSavedFeed(startIndex) {
            currentView = 'saved-feed';
            document.getElementById('gallery').classList.remove('active');
            document.getElementById('feed').style.display = 'block';
            
            renderFeed(savedPosts);
            
            // Scroll to the clicked post
            setTimeout(() => {
                const cards = document.querySelectorAll('.card');
                if (cards[startIndex]) {
                    cards[startIndex].scrollIntoView({ behavior: 'instant' });
                }
            }, 0);
        }

        function renderFeed(data) {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.setAttribute('data-id', item.id);
                card.innerHTML = `
                    ${item.dwell_time_ms ? '<div class="seen-badge">Seen</div>' : ''}
                    <div class="prompt visible">${item.prompt}</div>
                    <div class="bridge-container">
                        <button class="ready-btn" onclick="showBridge(this)">I am ready</button>
                        <div class="bridge">${item.bridge}</div>
                    </div>
                    <div class="controls">
                        <span class="like-btn ${item.liked ? 'active' : ''}" onclick="toggleLike('${item.id}', this)">Like</span>
                        <span class="dislike-btn" onclick="toggleDislike('${item.id}', this)">Dismiss</span>
                        <input type="text" class="thought-input" placeholder="Note..." onchange="saveComment('${item.id}', this.value)" value="${item.comment || ''}">
                    </div>`;
                feed.appendChild(card);
            });
            observeCards();
        }

        function showBridge(btn) {
            btn.nextElementSibling.classList.add('visible');
            btn.style.display = 'none';
        }

        async function triggerProxyCook() {
            showStatus("Cooking...", 0);
            const { data: history } = await _supabase.from('posts')
                .select('prompt, category, liked, comment')
                .or('liked.eq.true,comment.not.is.null')
                .limit(20);

            try {
                const response = await fetch(`${WORKER_URL}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history })
                });
                const result = await response.json();
                const newPosts = JSON.parse(result.choices[0].message.content).posts;
                await _supabase.from('posts').insert(newPosts);
                showStatus("Done!", 2000);
                loadFeed();
            } catch (e) {
                showStatus("Error.", 2000);
            }
        }

        async function toggleLike(id, el) {
            const active = el.classList.toggle('active');
            await _supabase.from('posts').update({ liked: active }).eq('id', id);
        }

        async function toggleDislike(id, el) {
            await _supabase.from('posts').update({ disliked: true }).eq('id', id);
            el.closest('.card').style.opacity = '0.2';
        }

        async function saveComment(id, val) {
            await _supabase.from('posts').update({ comment: val }).eq('id', id);
        }

        function observeCards() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const cardId = entry.target.getAttribute('data-id');
                    
                    if (entry.isIntersecting) {
                        // When card comes into view
                        entry.target.viewStart = Date.now();
                        activeCardId = cardId;
                    } else {
                        // When card leaves view
                        if (entry.target.viewStart) {
                            const dwell = Date.now() - entry.target.viewStart;
                            // Only update if they actually looked for more than 2 seconds
                            if (dwell > 2000) {
                                _supabase.from('posts')
                                    .update({ dwell_time_ms: dwell })
                                    .eq('id', cardId)
                                    .then(() => console.log(`Logged ${dwell}ms for ${cardId}`));
                            }
                            entry.target.viewStart = null; // Reset
                        }
                    }
                });
            }, { threshold: 0.6 }); // Trigger when 60% of the card is visible
            
            document.querySelectorAll('.card').forEach(c => observer.observe(c));
        }

        loadFeed();
    </script>
</body>
</html>
